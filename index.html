<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Journey planner : prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --panel-w:360px;
      --accent:#1976d2;
      --muted:#666;
      --bg:#f7f8fa;
      --light-bg:#fffefb;
      --border:#ffd8b6;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .app{display:flex;height:100vh}
    .panel{width:var(--panel-w);padding:18px;box-sizing:border-box;border-right:1px solid #eee;background:white;overflow:auto}
    .mapwrap{flex:1;position:relative}
    #map{position:absolute;inset:0}
    h1{font-size:18px;margin:0 0 10px 0;font-weight:600}
    label{display:block;margin-top:12px;font-size:13px;color:#222;font-weight:500}
    input[type="text"], input[type="date"], input[type="time"], select{
      width:100%;padding:8px 10px;margin-top:6px;border:1px solid #d0d4d9;border-radius:6px;box-sizing:border-box;font-size:14px;
    }
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    button{
      margin-top:18px;padding:11px 14px;border:none;background:var(--accent);color:white;border-radius:8px;cursor:pointer;font-weight:600;font-size:15px;
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    .meta{margin-top:12px;font-size:13px;color:var(--muted)}

    /* ====================== RESULTS CARD ====================== */
    .results{
      margin-top:20px;
      padding:16px;
      background:var(--light-bg);
      border:1px solid var(--border);
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      display:none;
    }
    .results-header{
      font-size:15px;
      font-weight:600;
      color:#222;
      margin-bottom:12px;
      padding-bottom:8px;
      border-bottom:1px solid #eee;
    }
    .result-row{
	  display: flex;
	  flex-direction: column;
	  align-items: flex-start;
	  gap: 4px;
	  margin-bottom: 10px;
    }
    .result-row .label{
      color:var(--muted);
      font-weight:500;
    }
    .result-row .value{
      font-weight:600;
      color:#111;
    }
    .highlight{
      font-size:18px;
      font-weight:700;
      color:var(--accent);
    }

    /*  TIPS */
    .tips{
      margin-top:16px;
      padding:14px;
      background:var(--bg);
      border-radius:8px;
      font-size:13px;
      color:#333;
    }

    /* Loading overlay */
    .loading-overlay{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.85);z-index:9999;
    }
    .loading-overlay.show{display:flex}
    .spinner{
      width:64px;height:64px;border-radius:50%;border:6px solid rgba(0,0,0,0.08);border-top-color:var(--accent);
      animation:spin 1s linear infinite;box-shadow:0 6px 20px rgba(0,0,0,0.06)
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:880px){
      .panel{width:100%;height:40vh;border-right:none;border-bottom:1px solid #eee}
      .app{flex-direction:column}
      .mapwrap{height:60vh}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel" id="leftPanel">
      <h1>Journey planner</h1>

      <label for="origin">Origin (lat,lng or name)</label>
      <input id="origin" type="text" placeholder="e.g. 6.9062614,79.9697339" value="6.9062614,79.9697339">

      <label for="destination">Destination (lat,lng or name)</label>
      <input id="destination" type="text" placeholder="e.g. 6.9076979,79.8580987" value="6.9076979,79.8580987">

      <div class="row">
        <div class="col">
          <label for="arrivalDate">Arrival date</label>
          <input id="arrivalDate" type="date">
        </div>
        <div class="col">
          <label for="arrivalTime">Arrival time</label>
          <input id="arrivalTime" type="time" step="60">
        </div>
      </div>

      <button id="getBtn">Get suggestions</button>

      <!-- RESULTS CARD -->
      <div class="results" id="results">
        <div class="results-header">Recommended departure</div>
		
		<div class="result-row">
          <div class="label">Total distance</div>
		  <div class="highlight" id="distance">--</div>
        </div>

        <div class="result-row">
          <div class="label">Suggested leave time</div>
          <div class="highlight" id="leaveTime">--</div>
        </div>

        <div class="result-row">
          <div class="label">Predicted travel time</div>
          <div class="highlight" id="predTime">--</div>
        </div>

        <div class="result-row">
          <div class="label">Route summary</div>
          <div class="highlight" id="summary">--</div>
        </div>

		<div class="result-row">
          <div class="label">Tips</div>
          <div class="value" id="tips">--</div>
        </div>
		
      </div>

    </div>

    <div class="mapwrap">
      <div id="map"></div>

      <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align:center">
          <div class="spinner"></div>
          <div style="margin-top:10px;color:#333;font-weight:600">Finding best time…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>

    const API_URL = "https://klthc47wel.execute-api.us-east-1.amazonaws.com/dev/predict";

    const map = L.map('map', {zoomControl:true}).setView([7, 80],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 25,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    const routeLayer = L.layerGroup().addTo(map);
    const markerLayer = L.layerGroup().addTo(map);

    function showLoading(show){
      const el = document.getElementById('loadingOverlay');
      if(show) el.classList.add('show'); else el.classList.remove('show');
    }
    function el(id){ return document.getElementById(id); }

    function decodePolyline(encoded) {

      if(!encoded) return [];
      let index = 0, lat = 0, lng = 0, coordinates = [];
      while (index < encoded.length) {
        let shift = 0, result = 0, b;
        do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1)); lat += dlat;
        shift = 0; result = 0;
        do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
        const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1)); lng += dlng;
        coordinates.push([lat * 1e-5, lng * 1e-5]);
      }
      return coordinates;
    }
	
    function renderRouteFromPolyline(encoded){
      routeLayer.clearLayers(); markerLayer.clearLayers();
      const coords = decodePolyline(encoded);
      if(coords.length===0) return;
      const latlngs = coords.map(c => [c[0], c[1]]);
      const poly = L.polyline(latlngs, {color:'#1976d2', weight:4, opacity:0.9}).addTo(routeLayer);
      map.fitBounds(poly.getBounds(), {padding:[40,40]});
      L.marker(latlngs[0]).addTo(markerLayer).bindPopup('Start');
      L.marker(latlngs[latlngs.length-1]).addTo(markerLayer).bindPopup('End');
    }

    function drawSparkline(data){
      const w = 240, h = 64, pad = 6;
      const container = el('sparkSvg');
      container.innerHTML = '';
      if(!data || data.length===0) return;
      const min = Math.min(...data), max = Math.max(...data);
      const scaleY = v => (max===min) ? h/2 : h - pad - ((v - min) / (max - min)) * (h - pad*2);
      const step = (w - pad*2) / (data.length - 1 || 1);
      let path = '';
      data.forEach((v,i)=>{
        const x = pad + i*step;
        const y = scaleY(v);
        path += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
      });
      const svg = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
        <path d="${path}" fill="none" stroke="#1976d2" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>
      </svg>`;
      container.innerHTML = svg;
    }

    async function callPredictAPI(payload){
      const resp = await fetch(API_URL, {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!resp.ok){ const text = await resp.text(); throw new Error('API error: ' + resp.status + ' - ' + text); }
      return resp.json();
    }
	

	function formatTime(dateObj) {
	  return dateObj.toLocaleTimeString([], {
		hour: 'numeric',
		minute: '2-digit',
		hour12: true
	  });
	}

	function formatDate(dateObj) {
	  return dateObj.toISOString().split('T')[0];
	}

	function buildReadableSummary(leaveIso, arrivalIso) {
	  if (!leaveIso || !arrivalIso) return '--';

	  const leave = new Date(leaveIso);
	  const arrive = new Date(arrivalIso);

	  return `If you depart at ${formatTime(leave)} on ${formatDate(leave)}, ` +
			 `you will reach your destination around ${formatTime(arrive)}.`;
	}
	
	function buildAlternativesText(alternatives) {
	  if (!alternatives || typeof alternatives !== 'object') return '--';

	  const lines = [];

	  if (alternatives.CLEAR) {
		const c = alternatives.CLEAR;
		lines.push(
		  `Leaving at ${formatTime(new Date(c.departure_iso))} ` +
		  `could get you there faster.`
		);
	  }

	  if (alternatives.RAIN) {
		const r = alternatives.RAIN;
		lines.push(
		  `If it rains, leaving around ${formatTime(new Date(r.departure_iso))} ` +
		  `may help you reach on time.`
		);
	  }

	  return lines.length > 0 ? lines.join(' ') : '--';
	}
	
	
	function isValidLatLng(value) {
	  if (!value) return false;

	  const parts = value.split(',');
	  if (parts.length !== 2) return false;

	  const lat = parseFloat(parts[0].trim());
	  const lng = parseFloat(parts[1].trim());

	  if (Number.isNaN(lat) || Number.isNaN(lng)) return false;
	  
	// approx. lat/long limits for Sri Lanka
	 if (lat < 5.9167 || lat > 9.85) return false;
	 if (lng < 79.5167 || lng > 81.8833) return false;

	  return true;
	}



    async function runSuggestion(){
      try{
        let origin = el('origin').value.trim();
        let destination = el('destination').value.trim();
        const date = el('arrivalDate').value;
        const time = el('arrivalTime').value;
		
		// OD Empty check
	    if(!origin || !destination) {alert('Please provide both origin and destination'); return;}

		// Lat,Lng format validation
		if (!isValidLatLng(origin) || !isValidLatLng(destination)) {alert('Origin and destination must be in lat,lng format (e.g. 6.12345,79.6789810) and must be within Sri Lanka'); return;}	
			
        if(!date || !time){ alert('Please provide arrival date and time'); return; }
        
		const arrivalIso = new Date(date + 'T' + time + ':00').toISOString();

        const payload = { origin, destination, arrival_time_iso: arrivalIso };

        showLoading(true);
        el('results').style.display = 'none';

        const result = await callPredictAPI(payload);
		
		const distance = result.distance || null;
        const leaveIso = result.suggested_leave_iso || null;
        const predMin = result.predicted_travel_minutes || result.predicted_travel_time_minutes || null;
        const poly = result.overview_polyline || (result.routes?.[0]?.overview_polyline?.points) || null;
        const summary = result.summary || (result.routes?.[0]?.summary) || '';
        //const tips = result.tips || '';
		const alternatives = result.alternatives || null;
		

		//distance
		el('distance').innerText = distance
		  ? `${distance.toFixed(1)} km`
		  : '--';

		// Suggested leave time (clean & single)
		el('leaveTime').innerText = leaveIso
		  ? new Date(leaveIso).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' })
		  : '--';

		// Predicted travel time (rounded)
		el('predTime').innerText = predMin
		  ? `${Math.round(predMin)} mins`
		  : '--';

		// Route summary (human-readable)
		if (leaveIso && result.estimated_arrival_iso) {
		  el('summary').innerText = buildReadableSummary(
			leaveIso,
			result.estimated_arrival_iso
		  );
		} else {
		  el('summary').innerText = '--';
		}

		//el('tips').innerText = tips;
		el('tips').innerText = alternatives
		  ? buildAlternativesText(alternatives)
		  : '--';

        el('results').style.display = 'block';

        if(poly) renderRouteFromPolyline(poly);
        if(Array.isArray(result.spark_values)) drawSparkline(result.spark_values);

      } catch(err){
        console.error(err);
        alert('Error: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    el('getBtn').addEventListener('click', runSuggestion);

    // Default date/time
    (function setDefaults(){
      const today = new Date();
      const yyyy = today.getFullYear().toString().padStart(4,'0');
      const mm = (today.getMonth()+1).toString().padStart(2,'0');
      const dd = today.getDate().toString().padStart(2,'0');
      el('arrivalDate').value = `${yyyy}-${mm}-${dd}`;
      const t = new Date(today.getTime() + 30*60000);
      const hh = t.getHours().toString().padStart(2,'0'), mi = t.getMinutes().toString().padStart(2,'0');
      el('arrivalTime').value = `${hh}:${mi}`;
    })();
  </script>
</body>
</html>
